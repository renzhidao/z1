<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>å¾®ä¿¡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      body {
        background-color: #f5f5f5;
        font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        -webkit-font-smoothing: antialiased;
      }
      .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
      .pt-safe-top { padding-top: env(safe-area-inset-top); }
      @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
      .slide-in-from-right { animation: slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
      @keyframes voice-1 { 0%, 100% { opacity: 1; } }
      @keyframes voice-2 { 0%, 30% { opacity: 0; } 31%, 100% { opacity: 1; } }
      @keyframes voice-3 { 0%, 60% { opacity: 0; } 61%, 100% { opacity: 1; } }
      .animate-voice-1 { animation: voice-1 1.5s infinite; }
      .animate-voice-2 { animation: voice-2 1.5s infinite; }
      .animate-voice-3 { animation: voice-3 1.5s infinite; }
    </style>
    <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0",
        "react/": "https://aistudiocdn.com/react@^19.2.0/",
        "react": "https://aistudiocdn.com/react@^19.2.0",
        "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
        "lucide-react": "https://aistudiocdn.com/lucide-react@^0.555.0",
        "@vitejs/plugin-react": "https://aistudiocdn.com/@vitejs/plugin-react@^5.1.1",
        "vite": "https://aistudiocdn.com/vite@^7.2.6",
        "path": "https://aistudiocdn.com/path@^0.12.7"
      }
    }
    </script>
    <link rel="stylesheet" href="./index.css">
    
    <!-- Core Deps -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.0/dist/peerjs.min.js"></script>

    <!-- Core Loader & Shim -->
    <script type="module">
      window.process = { env: { NODE_ENV: 'production' } };
      
      // 1. Shim Window UI (Bridge Core -> React)
      window.ui = {
        init: () => {},
        renderList: () => { window.dispatchEvent(new CustomEvent('core-ui-update', { detail: { type: 'list' } })); },
        appendMsg: (msg) => { window.dispatchEvent(new CustomEvent('core-ui-update', { detail: { type: 'msg', data: msg } })); },
        updateSelf: () => { window.dispatchEvent(new CustomEvent('core-ui-update', { detail: { type: 'self' } })); },
        clearMsgs: () => { window.dispatchEvent(new CustomEvent('core-ui-update', { detail: { type: 'clear' } })); },
        downloadBlob: (blob, name) => { 
            console.log('Download requested:', name);
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = name;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        },
        loadRemoteMedia: () => {} 
      };
      // Prevent native UI events
      window.uiEvents = { init: () => {} };

      // 2. Load Core Modules Manually
      // We use a base path variable to prevent Vite from resolving these paths at build time.
      const CORE_BASE = './core/';
      
      const moduleNames = [
        'modules/constants.js',
        'modules/utils.js',
        'modules/state.js',
        'modules/db.js',
        'modules/protocol.js',
        'modules/smart-core.js',
        'modules/p2p.js',
        'modules/hub.js',
        'modules/mqtt.js'
      ];

      async function loadCore() {
        try {
          console.log('ðŸš€ Booting Core...');
          const cfg = await fetch(CORE_BASE + 'config.json').then(r => r.json());
          window.config = cfg;

          for (const name of moduleNames) {
            // Use concatenated string to evade static analysis
            const m = await import(/* @vite-ignore */ CORE_BASE + name);
            if (m.init) m.init();
          }

          // Start the main loop
          await import(/* @vite-ignore */ CORE_BASE + 'app.js');
          
          console.log('âœ… Core Ready');
          window.__CORE_READY__ = true;
          window.dispatchEvent(new Event('core-ready'));
        } catch (e) {
          console.error('Core Load Failed:', e);
        }
      }
      
      loadCore();
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="./index.tsx"></script>
  </body>
</html>