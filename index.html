<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>å¾®ä¿¡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      body {
        background-color: #f5f5f5;
        font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        -webkit-font-smoothing: antialiased;
      }
      .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
      .pt-safe-top { padding-top: env(safe-area-inset-top); }
      @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
      .slide-in-from-right { animation: slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
      @keyframes voice-1 { 0%, 100% { opacity: 1; } }
      @keyframes voice-2 { 0%, 30% { opacity: 0; } 31%, 100% { opacity: 1; } }
      @keyframes voice-3 { 0%, 60% { opacity: 0; } 61%, 100% { opacity: 1; } }
      .animate-voice-1 { animation: voice-1 1.5s infinite; }
      .animate-voice-2 { animation: voice-2 1.5s infinite; }
      .animate-voice-3 { animation: voice-3 1.5s infinite; }
    </style>
    <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0",
        "react/": "https://aistudiocdn.com/react@^19.2.0/",
        "react": "https://aistudiocdn.com/react@^19.2.0",
        "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
        "lucide-react": "https://aistudiocdn.com/lucide-react@^0.555.0",
        "@vitejs/plugin-react": "https://aistudiocdn.com/@vitejs/plugin-react@^5.1.1",
        "vite": "https://aistudiocdn.com/vite@^7.2.6",
        "path": "https://aistudiocdn.com/path@^0.12.7"
      }
    }
    </script>
    <link rel="stylesheet" href="./index.css">
    
    <!-- Core Deps -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.0/dist/peerjs.min.js"></script>

    <!-- Core Loader & Shim -->
    <script type="module">
      window.process = { env: { NODE_ENV: 'production' } };
      
      // 1. Shim Window UI (Bridge Core -> React)
      window.ui = {
        init: () => {},
        renderList: () => { window.dispatchEvent(new CustomEvent('core-ui-update', { detail: { type: 'list' } })); },
        appendMsg: (msg) => { window.dispatchEvent(new CustomEvent('core-ui-update', { detail: { type: 'msg', data: msg } })); },
        updateSelf: () => { window.dispatchEvent(new CustomEvent('core-ui-update', { detail: { type: 'self' } })); },
        clearMsgs: () => { window.dispatchEvent(new CustomEvent('core-ui-update', { detail: { type: 'clear' } })); },
        downloadBlob: (blob, name) => { 
            console.log('Download requested:', name);
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = name;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        },
        loadRemoteMedia: () => {} 
      };
      // Prevent native UI events
      window.uiEvents = { init: () => {} };

      // 2. Load Core Modules Manually
      // FIX: Calculate absolute path to 'core/' based on window.location
      function getCoreBase() {
          const loc = window.location;
          let path = loc.pathname;
          if (path.endsWith('.html') || path.endsWith('.htm')) {
              path = path.substring(0, path.lastIndexOf('/') + 1);
          }
          if (!path.endsWith('/')) {
              path = path.substring(0, path.lastIndexOf('/') + 1);
          }
          return loc.origin + path + 'core/';
      }

      const CORE_BASE = getCoreBase();
      
      const moduleNames = [
        'modules/constants.js',
        'modules/utils.js',
        'modules/state.js',
        'modules/db.js',
        'modules/protocol.js',
        'modules/smart-core.js',
                'modules/p1-media-fix.js',
                'modules/p1-call-webrtc.js',
                'modules/p1-call-ui.js',
                'modules/p1-voice.js',
        'modules/p2p.js',
        'modules/hub.js',
        'modules/mqtt.js'
      ];

      function loadScript(url) {
        return new Promise((resolve) => {
          const s = document.createElement('script');
          s.src = url;
          s.onload = resolve;
          s.onerror = () => { console.warn('Script Load Failed (Non-fatal):', url); resolve(); };
          document.head.appendChild(s);
        });
      }

      async function loadCore() {
        try {
          console.log('ðŸš€ Booting Core from:', CORE_BASE);
          
          // 0. Load MP4Box dynamically (Avoids Vite bundling issues)
          await loadScript(CORE_BASE + 'modules/mp4box.all.min.js');

          // 1. Register Service Worker
          if ('serviceWorker' in navigator) {
             try {
               const __p1_sw_reg = await navigator.serviceWorker.register('./sw.js', { scope: './' });
                              console.log('âœ… SW Registered:', __p1_sw_reg && __p1_sw_reg.scope);
                              await navigator.serviceWorker.ready;
                              if (!navigator.serviceWorker.controller) {
                                  const k = '__sw_force_reload_once__';
                                  if (!sessionStorage.getItem(k)) {
                                      sessionStorage.setItem(k, '1');
                                      location.reload();
                                      return;
                                  }
                              }
               console.log('âœ… SW Registered');
             } catch(err) {
               console.warn('âš ï¸ SW Registration Failed (Non-fatal):', err);
             }
          }

          // 2. Load Config
          const cfg = await fetch(CORE_BASE + 'config.json').then(r => {
             if(!r.ok) throw new Error(`Config Load 404: ${r.statusText}`);
             return r.json();
          });
          window.config = cfg;

          // 3. Import Modules
          for (const name of moduleNames) {
            const url = CORE_BASE + name;
            const m = await import(/* @vite-ignore */ url);
            if (m.init) m.init();
          }

          // 4. Start Main Loop
          const appUrl = CORE_BASE + 'app.js';
          const appMod = await import(/* @vite-ignore */ appUrl);
          if (appMod.init) {
              appMod.init();
          }
          
          console.log('âœ… Core Ready');
          window.__CORE_READY__ = true;
          window.dispatchEvent(new Event('core-ready'));
        } catch (e) {
          console.error('Core Load Failed:', e);
          window.__CORE_ERROR__ = e.message || String(e);
          window.dispatchEvent(new Event('core-error'));
        }
      }
      
      loadCore();
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="./index.tsx"></script>
  </body>
</html>